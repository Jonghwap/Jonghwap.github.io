{% assign items = include.publications | default: site.publications %}
{% if items and items.size > 0 %}
{% assign has_order = items | where_exp: "p", "p.order" %}
{% if has_order and has_order.size == items.size %}
{% comment %}Respect manual ordering when every item provides an order field (higher numbers appear first).{% endcomment %}
{% assign sorted = items | sort: "order" | reverse %}
{% else %}
{% comment %}Fallback ordering: sort by title to stabilize, then by year (newest first).{% endcomment %}
{% assign sorted_by_title = items | sort: "title" %}
{% assign sorted = sorted_by_title | sort: "year" | reverse %}
{% endif %}
{% assign total = sorted.size %}
<ol class="publication-list">
  {% for pub in sorted %}
  <li class="publication-entry">
    <span class="publication-rank">#{{ total | minus: forloop.index0 }}</span>
    <div class="publication-details">
      <div class="publication-title">
        <strong>{{ pub.title }}</strong>
      </div>
      {% if pub.coauthors and pub.coauthors.size > 0 %}
      <div class="publication-coauthors">With {{ pub.coauthors | join: ", " }}</div>
      {% endif %}
      <div class="publication-meta">
        <em>{{ pub.journal }}</em>, {{ pub.year }}    
        {% assign has_journal_url = pub.journal_url and pub.journal_url != '' and pub.journal_url != empty %}
        {% assign has_arxiv = pub.arxiv and pub.arxiv != '' and pub.arxiv != empty %}
        {% assign has_abstract = pub.abstract and pub.abstract != '' and pub.abstract != empty %}
        {% assign show_link_row = has_journal_url or has_arxiv or has_abstract %}
        {% assign abstract_id = pub.title | append: '-' | append: forloop.index0 | slugify | prepend: 'abstract-' %}
        {% if show_link_row %}   
        <span class="publication-links">
          {% if has_arxiv %}          
          <a class="arxiv-button" href="{{ pub.arxiv }}" target="_blank" rel="noopener">arXiv</a>
          {% endif %}
          {% if has_journal_url %}          
          <a class="journal-button" href="{{ pub.journal_url }}" target="_blank" rel="noopener">journal</a>
          {% endif %}
          {% if has_abstract %}
          <button class="summary-toggle" type="button" aria-expanded="false" aria-controls="{{ abstract_id }}">
            <span class="summary-label">summary</span>
            <span class="summary-arrow" aria-hidden="true">â–¼</span>
          </button>
          {% endif %}          
        </span>   
        {% endif %}
      </div>
      {% if has_abstract %}
      <div class="abstract-panel" id="{{ abstract_id }}" hidden>
        <div class="abstract-content">{{ pub.abstract | markdownify }}</div>
      </div>
      {% endif %}      
    </div>
  </li>
  {% endfor %}
</ol>
<script>
  (function() {
    if (window.__publicationSummaryInitialized) return;
    window.__publicationSummaryInitialized = true;
    document.addEventListener('click', function(event) {
      const button = event.target.closest('.summary-toggle');
      if (!button) return;

      const targetId = button.getAttribute('aria-controls');
      const panel = document.getElementById(targetId);
      if (!panel) return;

      const expanded = button.getAttribute('aria-expanded') === 'true';
      button.setAttribute('aria-expanded', (!expanded).toString());
      button.classList.toggle('is-open', !expanded);
      panel.hidden = expanded;
    });
  })();
</script>
{% else %}
<p>No publications have been added yet. Add entries under <code>_publications/</code> to list them.</p>
{% endif %}
